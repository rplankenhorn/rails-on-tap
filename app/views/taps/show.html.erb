<% content_for :title, "#{@tap.name} - Taps - Rails on Tap" %>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
  <h1><%= @tap.name %></h1>
  <div>
    <%= link_to "Edit", edit_tap_path(@tap), class: "btn" %>
    <%= link_to "Back to Taps", taps_path, class: "btn" %>
  </div>
</div>

<div class="grid">
  <!-- Tap Status -->
  <div class="card">
    <h2>Status</h2>
    <div style="text-align: center; padding: 2rem;">
      <% if @tap.active? %>
        <span class="badge badge-success" style="font-size: 1.5rem; padding: 0.5rem 1rem;">‚úì Active</span>
      <% else %>
        <span class="badge badge-warning" style="font-size: 1.5rem; padding: 0.5rem 1rem;">‚ö† Inactive</span>
      <% end %>
    </div>
    
    <table>
      <tr>
        <th>Tap Name:</th>
        <td><%= @tap.name %></td>
      </tr>
      <tr>
        <th>Notes:</th>
        <td><%= @tap.notes || "No notes" %></td>
      </tr>
      <% if @tap.meter %>
        <tr>
          <th>Flow Meter:</th>
          <td><%= @tap.meter.meter_name %></td>
        </tr>
      <% end %>
      <% if @tap.flow_toggle %>
        <tr>
          <th>Flow Toggle:</th>
          <td><%= @tap.flow_toggle.toggle_name %></td>
        </tr>
      <% end %>
      <% if @tap.temperature_sensor %>
        <tr>
          <th>Temp Sensor:</th>
          <td><%= @tap.temperature_sensor.sensor_name %></td>
        </tr>
        <% if @tap.current_temperature %>
          <tr>
            <th>Current Temp:</th>
            <td>üå°Ô∏è <%= @tap.current_temperature.round(1) %>¬∞C</td>
          </tr>
        <% end %>
      <% end %>
    </table>
  </div>

  <!-- Current Keg -->
  <div class="card">
    <h2>Current Keg</h2>
    <% if @tap.current_keg %>
      <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px;">
        <h3 style="font-size: 1.3rem; margin-bottom: 0.5rem;">
          <%= link_to @tap.current_keg.beverage.name, @tap.current_keg %>
        </h3>
        <p style="color: #666; margin-bottom: 0.5rem;">
          <%= @tap.current_keg.beverage.producer.name %> - 
          <%= @tap.current_keg.beverage.style %>
        </p>
        
        <% if @tap.current_keg.beverage.abv %>
          <p style="margin-bottom: 0.5rem;">üç∫ <%= @tap.current_keg.beverage.abv %>% ABV</p>
        <% end %>
        
        <div style="background: #ecf0f1; border-radius: 4px; height: 30px; margin: 1rem 0;">
          <div style="background: #27ae60; height: 100%; border-radius: 4px; width: <%= @tap.current_keg.percent_full %>%;"></div>
        </div>
        
        <p style="font-size: 1.1rem; text-align: center;">
          <strong><%= number_to_human(@tap.current_keg.remaining_volume_ml, units: { unit: "ml" }) %></strong> remaining
          (<%= @tap.current_keg.percent_full.round(1) %>%)
        </p>
        
        <p style="color: #666; text-align: center; margin-top: 0.5rem;">
          Started <%= time_ago_in_words(@tap.current_keg.start_time) %> ago
        </p>
        
        <%= button_to "End This Keg", end_keg_keg_path(@tap.current_keg), method: :post, class: "btn btn-danger", style: "margin-top: 1rem; width: 100%;", data: { confirm: "Are you sure you want to end this keg?" } %>
      </div>
    <% else %>
      <div style="text-align: center; padding: 3rem; background: #f8f9fa; border-radius: 4px;">
        <p style="color: #999; font-size: 1.2rem; margin-bottom: 1rem;">üîå No keg attached</p>
        <%= link_to "Attach a Keg", attach_keg_tap_path(@tap), class: "btn btn-success" %>
      </div>
    <% end %>
  </div>
</div>

<!-- Recent Drinks from This Tap -->
<div class="card">
  <h2>Recent Drinks from This Tap</h2>
  <% if @tap.current_keg && @tap.current_keg.drinks.any? %>
    <table>
      <thead>
        <tr>
          <th>User</th>
          <th>Volume</th>
          <th>Time</th>
          <th>Session</th>
        </tr>
      </thead>
      <tbody>
        <% @tap.current_keg.drinks.order(created_at: :desc).limit(20).each do |drink| %>
          <tr>
            <td><%= drink.user.display_name %></td>
            <td><%= number_to_human(drink.volume_ml, units: { unit: "ml" }) %></td>
            <td><%= time_ago_in_words(drink.created_at) %> ago</td>
            <td>
              <% if drink.drinking_session %>
                <%= link_to drink.drinking_session.name, session_path(drink.drinking_session) %>
              <% else %>
                <span style="color: #999;">-</span>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% else %>
    <p style="color: #999; text-align: center; padding: 2rem;">No drinks recorded yet</p>
  <% end %>
</div>

<!-- Keg History -->
<div class="card">
  <h2>Keg History</h2>
  <% past_kegs = @tap.kegs.finished.includes(:beverage).order(end_time: :desc).limit(10) %>
  <% if past_kegs.any? %>
    <table>
      <thead>
        <tr>
          <th>Beverage</th>
          <th>Started</th>
          <th>Finished</th>
          <th>Drinks</th>
          <th>Volume Poured</th>
        </tr>
      </thead>
      <tbody>
        <% past_kegs.each do |keg| %>
          <tr>
            <td><%= link_to keg.beverage.name, keg %></td>
            <td><%= keg.start_time&.strftime("%b %d, %Y") || "-" %></td>
            <td><%= keg.end_time&.strftime("%b %d, %Y") || "-" %></td>
            <td><%= keg.drinks.count %></td>
            <td><%= ((keg.full_volume_ml - keg.remaining_volume_ml) / 1000.0).round(1) %>L</td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% else %>
    <p style="color: #999; text-align: center; padding: 2rem;">No previous kegs</p>
  <% end %>
</div>
